name: Deploy AKS (init-k8s.ps1)

on:
  workflow_dispatch:
    inputs:
      namespace:
        description: "Namespace Kubernetes à (re)déployer"
        required: false
        default: "okotwica"

concurrency:
  group: deploy-aks-${{ github.ref }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_RESOURCE_GROUP:  ${{ secrets.AZURE_RESOURCE_GROUP }}
  AKS_CLUSTER_NAME:     ${{ secrets.AKS_CLUSTER_NAME }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          # Secret au format JSON créé via un Service Principal (AZURE_CREDENTIALS)
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ env.AZURE_RESOURCE_GROUP }}
          cluster-name:  ${{ env.AKS_CLUSTER_NAME }}
          subscription:  ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Kubectl sanity check
        run: |
          kubectl version --client
          kubectl get nodes

      - name: Run deployment script
        shell: pwsh
        run: |
          Write-Host "Running init-k8s.ps1 from CI..."
          ./init-k8s.ps1

      - name: Verify resources
        run: |
          kubectl get ns
          kubectl get all -n ${{ github.event.inputs.namespace || 'okotwica' }}
